# 基于Electron与YOLOv8的可逆视频脱敏系统

MeSec是一个可以对视频进行可逆的隐私保护处理的程序。其利用深度学习方法自动检测视频中的敏感对象，并结合`OpenCV`实现多种风格的模糊化。与传统“破坏性“的打码不同，本项目的核心在于其可逆性。系统在模糊敏感区域的同时会将原始像素数据进行`AES-256-GCM`加密，并将加密后的数据嵌入视频文件本身。只有持有正确密钥的用户才可以完全恢复原始视频内容，否则只能看见经过处理的视频。

## 一、功能

本项目分为前后端两部分，前端使用`Electron`和`Vue 3`构建用户交互界面，后端逻辑则由`Python`脚本承担，利用`PyTorch`和`OpenCV`进行视频处理。

### 1、视频管线

我在管线`video_pipeline.py`中将视频处理分为了帧读取（Producer）、帧处理（Worker）和帧写入（Consumer）三部分，让I/O操作可以和图像处理并行执行，避免资源浪费。对于对象跟踪功能，则集成了`ultralytics`库调用`YOLOv8`模型。系统不仅支持自动检测预定义的COCO类别（person, car, ...），还引入了`OpenCV`的CSRT跟踪器`cv2.TrackerCSRT`。当用户在首帧手动框选区域后，系统能自动在后续帧中跟踪该区域，实现了对非标准目标的脱敏。在脱敏上，实现了三种高斯模糊、马赛克、像素化三种去识别化算法。

![ui-pipeline](D:\MeSec\doc\ui-pipeline.png)

### 2、手动区域选取

为了弥补自动检测的局限性，我在前端开发了`ManualRoiDialog.vue`组件，提供了一个直观的交互界面。当用户拖入视频时，前端通过`FFmpeg`或`HTML5 Video API`快速捕获视频首帧，并将其绘制在 `<canvas>` 上。`Canvas`实现了完整的鼠标事件监听，用户可以在画布上自由拖拽绘制矩形框。但由于`Canvas`显示尺寸通常小于视频实际分辨率，我还编写了坐标转换逻辑，确保前端绘制的坐标能精确映射回视频的原始分辨率坐标系，并传递给`Python`后端进行跟踪处理。

![ui-roi](D:\MeSec\doc\ui-roi.png)

### 3、可逆加密机制

在对敏感区域应用模糊滤镜之前，系统首先提取该区域的原始像素数据为`NumPy`数组，再使用`cryptography`库，采用`AES-256-GCM`算法对像素数据进行加密。选择GCM模式是因为它同时提供了机密性和完整性校验。每个ROI块都生成唯一的`nonce`，加密后输出`nonce`、`ciphertext`和`tag`。

加密后的数据量巨大，我设计了两种存储策略。第一种是独立数据包，其将所有帧的加密ROI数据序列化并压缩存储。第二种是嵌入MP4，利用MP4容器格式的灵活性，通过`mp4_packager.py`将加密数据写入自定义的`UUID Box`中。这样生成的视频文件既是一个标准的MP4文件，又是一个自包含的加密容器。

### 4、视频还原与验证

在`restore_video.py`中，我实现了逆向工程逻辑。在解密前，系统利用HMAC验证数据包是否被篡改，防止恶意注入。验证完整性后，系统读取加密元数据中的坐标信息`(x, y, w, h)`，解密出原始像素字节流，并将其重塑为`NumPy`数组，最后覆盖回视频帧的对应位置。

![ui](D:\MeSec\doc\ui-result.png)

### 5、前端

在`HomeView.vue`中，我构建了整个应用的主控台。用户可以灵活切换“自动检测”与“手动模式”，选择检测类别和模糊风格。通过监听后端脚本的标准输出`stdout/stderr`，前端实现了实时的进度条和状态横幅`StatusBanner.vue`，让用户清晰感知处理进度。任务完成后，界面会展示生成的AES密钥、HMAC密钥以及输出文件的路径。

![ui](D:\MeSec\doc\ui.png)

## 二、思考

在开发MeSec的过程中，我对数字媒体安全有了更深的理解。

众所周知，传统的视频脱敏是不可逆的，这虽然保护了隐私，但也破坏了数据的原始价值。例如，在自动驾驶数据采集中，我们需要模糊掉路人的脸来避免侵犯隐私权，但如果后续需要分析具体的边缘案例进行系统优化，原始数据的丢失将是巨大的损失。由此，本项目将加密和脱敏分离，并进行分级访问控制。一方面，公众只能看到经过模糊处理的视频，满足了隐私合规要求；另一方面，持有密钥的用户可以无视模糊区域，获取原始数据用于分析。

此外，本项目的”加密信息嵌入“功能利用了MP4文件格式允许自定义Box的特性，这本质上是一种隐写术的应用。加密数据隐藏在视频文件的元数据中，不影响标准播放器的解码，普通用户甚至不会察觉数据的存在，这无疑给了我们一些警示。攻击者完全可以利用类似的机制将恶意代码嵌入合法的视频流中，传统的防火墙往往难以检测。因此，在`restore_video.py`中强制实施HMAC完整性校验不仅是为了防止数据损坏，更是为了防止恶意篡改。

